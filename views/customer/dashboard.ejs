<!DOCTYPE html>
<html>
<head>
  <title>Customer Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #ffffff;
    }

    .header {
      background: #1f2937;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      padding: 20px;
    }

    h2 {
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: #5e8046;
      color: white;
    }

    button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }

    .stop { background: orange; color: white; }
    .resume { background: green; color: white; }
    .cancel { background: red; color: white; }

    .status-active { color: green; font-weight: bold; }
    .status-stopped { color: orange; font-weight: bold; }
    .status-cancelled { color: red; font-weight: bold; }
.status-expired {
  color: #d32f2f;
  font-weight: 600;
}
    .no-subscriptions {
      text-align: center;
      padding: 20px;
      color: #555;
      font-weight: bold;
    }

    @media(max-width: 768px){
      table, th, td {
        font-size: 14px;
      }
      button {
        padding: 4px 8px;
        font-size: 12px;
      }
    }
     /* ===== Loader Overlay ===== */
  #loaderOverlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    flex-direction: column;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #ddd;
    border-top: 5px solid #5e8046;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loader-text {
    margin-top: 12px;
    font-weight: bold;
    color: #333;
  }
  .order-btn {
  display: inline-block;
  padding: 6px 12px;
  border: 1.5px solid #5e8046;
  color: #5e8046;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  text-decoration: none;
  background: transparent;
}

.order-btn:hover {
  background: #5e8046;
  color: #fff;
}

  </style>
</head>
<body>
<div id="loaderOverlay">
  <div class="spinner"></div>
  <div class="loader-text">Processing…</div>
</div>

<!-- <div class="header">
  <div>Welcome <%= customer ? customer.name : "Customer" %></div>
</div> -->

<div class="container">
  <h2>Your Subscriptions</h2>

  <% if (!customer || !customer.subscriptions || customer.subscriptions.length === 0) { %>
    <div class="no-subscriptions">No subscriptions found.</div>
  <% } else { %>
    <table>
      <tr>
        <th>Product</th>
        <th>Frequency</th>
        <th>Status</th>
        <th>Total</th>
        <th>Subscription Start</th>
         <th>Next Shipping</th>
        <th>Subscription End</th>
        
        <th>Action</th>
      </tr>

      <% customer.subscriptions.forEach(sub => { %>
        <tr>
          <td><%= sub.product %></td>
          <td><%= sub.frequency %> ( <%= sub.deliveryDays || "-" %> )</td>
          <td class="status-<%= sub.status === 'cancelled' ? 'expired' : sub.status %>">
  <%= sub.status === 'cancelled' ? 'Expired' : sub.status %>
</td>

          <td>₹ <%= sub.totalAmount %></td>
          <td>
  <%= new Date(sub.createdAt).toLocaleString("en-IN", {
      timeZone: "Asia/Kolkata",
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
  }) %>
</td>

          <td>
  <%= sub.nextShippingDate
    ? new Date(sub.nextShippingDate).toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      })
    : "-" %>
</td>

<td>
  <%= sub.subscriptionEndDate
    ? new Date(sub.subscriptionEndDate).toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      })
    : "-" %>
</td>

          
          <td>
  <button class="resume"
    onclick="openOrdersModal('<%= sub.id %>')">
    Show Orders
  </button>

  <% if(sub.status === "active") { %>
    <form style="display:inline;" method="POST"
      action="/customer/subscription/<%= sub.id %>/stop?email=<%= encodeURIComponent(customer.email) %>">
      <button class="stop">Stop</button>
    </form>
  <% } else if(sub.status === "stopped") { %>
    <form style="display:inline;" method="POST"
      action="/customer/subscription/<%= sub.id %>/resume?email=<%= encodeURIComponent(customer.email) %>">
      <button class="resume">Resume</button>
    </form>
  <% } %>
</td>

        </tr>
      <% }) %>
    </table>
  <% } %>
</div>
<script>
const loader = document.getElementById("loaderOverlay");

document.querySelectorAll("form").forEach(form => {
  form.addEventListener("submit", (e) => {
    const action = form.action;

    // ================= Stop Subscription Check =================
    if (action.includes("/stop")) {
      const row = form.closest("tr");
      const nextShippingCell = row.querySelector("td:nth-child(6)"); // Next Shipping column
      const nextShippingText = nextShippingCell.textContent.trim();

      if (nextShippingText && nextShippingText !== "-") {
        const nextDate = new Date(nextShippingText);
        const now = new Date();
        const diffHours = (nextDate - now) / (1000 * 60 * 60);

        if (diffHours <= 24) {
          e.preventDefault(); // stop form submit
          alert("⛔ Cannot stop subscription within 24 hours of next delivery.");
          return;
        }
      }
    }

    // ================= Resume Subscription Check =================
    if (action.includes("/resume")) {
      const row = form.closest("tr");
      const nextShippingCell = row.querySelector("td:nth-child(6)"); // Next Shipping column
      const nextShippingText = nextShippingCell.textContent.trim();

      if (nextShippingText && nextShippingText !== "-") {
        const nextDate = new Date(nextShippingText);
        const now = new Date();
        const diffHours = (nextDate - now) / (1000 * 60 * 60);

        // optional: prevent resuming if next shipping is in past or already today
        if (diffHours <= 1) {
          e.preventDefault();
          alert("⛔ Cannot resume subscription immediately before next delivery.");
          return;
        }
      }
    }

    // ================= Show Loader and Disable Buttons =================
    loader.style.display = "flex";
    document.querySelectorAll("button").forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.6";
      btn.style.cursor = "not-allowed";
    });
  });
});

function openOrdersModal(subscriptionId) {
  const modal = document.getElementById("ordersModal");
  const tbody = document.getElementById("ordersTableBody");

  modal.style.display = "block";
  tbody.innerHTML = `<tr><td colspan="4">Loading…</td></tr>`;

  fetch(`/customer/subscription/${subscriptionId}/orders`)
    .then(res => res.json())
    .then(data => {
      if (!data.orders || data.orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">No orders created yet</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      data.orders.forEach(order => {
        tbody.innerHTML += `
          <tr>
            <td>
  ${
    order.shopifyOrderId && order.order_number
      ? `<a
           href="https://pbwfoods.com/account/orders/${order.order_status_url}"
           target="_blank"
           class="order-btn"
         >
           PBW${order.order_number}
         </a>`
      : "-"
  }
</td>
            <td>${order.subscription?.product || "-"}</td>
            <td>${new Date(order.shippingDate).toDateString()}</td>
            <td>${order.status}</td>
          </tr>
        `;
      });
    })
    .catch(() => {
      tbody.innerHTML = `<tr><td colspan="4">Failed to load orders</td></tr>`;
    });
}

function closeOrdersModal() {
  document.getElementById("ordersModal").style.display = "none";
}
</script>

<div id="ordersModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:10000;">
  <div style="background:#fff; max-width:800px; margin:60px auto; padding:20px; border-radius:8px; position:relative;">
    <h3>Subscription Orders</h3>

    <button onclick="closeOrdersModal()"
      style="position:absolute; top:10px; right:10px;">✕</button>

    <table style="margin-top:15px;">
      <thead>
        <tr>
            <th>Order</th>
          <th>Product</th>
          <th>Shipping Date</th>
          <th>Status</th>
       
        </tr>
      </thead>
      <tbody id="ordersTableBody">
        <tr><td colspan="4">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>

</body>
</html>
