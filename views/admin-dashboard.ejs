<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #f3f4f6;
    color: #111827;
  }

  .container {
    display: flex;
    height: 100vh;
  }

  /* ===== Sidebar ===== */
  .sidebar {
    width: 240px;
    background: #111827;
    color: #fff;
    padding: 20px;
    box-sizing: border-box;
  }

  .sidebar h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
  }

  .sidebar a {
    display: block;
    color: #d1d5db;
    text-decoration: none;
    padding: 10px 12px;
    margin-bottom: 6px;
    border-radius: 6px;
    transition: background 0.2s, color 0.2s;
    font-size: 14px;
  }

  .sidebar a.active,
  .sidebar a:hover {
    background: #1f2937;
    color: #ffffff;
  }

  .sidebar a:last-child {
    margin-top: 20px;
    background: #7c2d12;
    color: #fff;
  }

  .sidebar a:last-child:hover {
    background: #9a3412;
  }

  /* ===== Content ===== */
  .content {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
  }

  h2 {
    margin-top: 0;
    font-size: 22px;
    margin-bottom: 16px;
  }

  /* ===== Search ===== */
  #adminSearch {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    outline: none;
    font-size: 14px;
  }

  #adminSearch:focus {
    border-color: #2563eb;
  }

  /* ===== Tables ===== */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #ffffff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  th {
    background: #5e8046;
    color: white;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
  }

  td {
    font-size: 13px;
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
  }

  tr:hover td {
    background: #f9fafb;
  }

  /* ===== Buttons ===== */
  button {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 5px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    cursor: pointer;
    transition: all 0.2s;
  }

  button:hover {
    background: #f3f4f6;
  }

  button[type="submit"] {
    background: #2563eb;
    color: #fff;
    border: none;
    width: 85px;
  }

  button[type="submit"]:hover {
    background: #1d4ed8;
  }

  /* Danger buttons (Cancel / Logout) */
  form[action*="cancel"] button,
  .sidebar a[href*="logout"] {
    background: #dc2626;
    color: #fff;
    border: none;
  }

  form[action*="cancel"] button:hover {
    background: #b91c1c;
  }

  /* ===== Select ===== */
  select {
    padding: 6px;
    font-size: 13px;
    border-radius: 5px;
    border: 1px solid #d1d5db;
    background: #fff;
  }

  /* ===== Modals ===== */
  #ordersModal > div,
  #addressModal > div {
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  /* ===== Password text ===== */
  .password-text {
    font-family: monospace;
    letter-spacing: 1px;
  }

  /* ===== Status emphasis ===== */
  strong {
    text-transform: capitalize;
  }
  .action-cell {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

.action-form {
  display: inline;
}

.btn {
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  white-space: nowrap;
  transition: background 0.2s, opacity 0.2s;
}

/* Button colors */
.btn-success {
  background: #16a34a;
  color: #fff;
}
.btn-success:hover { background: #15803d; }

.btn-warning {
  background: #f59e0b !important;
  color: #fff;
}
.btn-warning:hover { background: #d97706; }

.btn-danger {
  background: #dc2626 !important;
  color: #fff;
}
.btn-danger:hover { background: #b91c1c; }

.btn-secondary {
  background: green;
  color: #ffffff;
}
.btn-secondary:hover { background: #d1d5db; }

</style>

</head>
<body>

<div class="container">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3>Admin Panel</h3>

    <a href="/admin/customers" class="<%= page === 'customers' ? 'active' : '' %>">
      Customers
    </a>

    <a href="/admin/subscriptions" class="<%= page === 'subscriptions' ? 'active' : '' %>">
      Subscriptions
    </a>

<a href="/admin/dashboard?page=shopify-orders"
   class="<%= page === 'shopify-orders' ? 'active' : '' %>">
  Shopify Orders
</a>

    <br>
    <a href="/admin/logout">Logout</a>
  </div>

  <!-- CONTENT -->
  <div class="content">
<div style="margin-bottom:15px;">
  <input
    type="text"
    id="adminSearch"
    placeholder="Search by email, product, subscription ID, order ID…"
    style="padding:8px; width:300px; max-width:100%;"
    onkeyup="filterTable()"
  />
</div>

   <% if (page === "customers") { %>
  <h2>Customers</h2>

  <table id="adminTable">
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Contact</th>
      <th>Address</th>
      <th>Total Subs</th>
      <th>Active Subs</th>
    </tr>

    <% customers.forEach(c => { 
      const active = c.subscriptions.filter(s => s.status === "active").length;
    %>
      <tr>
        <td><%= c.name %></td>
        <td><%= c.email %></td>
        <td><%= c.contact || "-" %></td>

        <!-- Address -->
        <td>
  <% if (c.address) { %>
    <button
      type="button"
      onclick='showAddress(<%- JSON.stringify(c.address) %>)'
      style="padding:4px 8px; cursor:pointer;"
    >
      View
    </button>
  <% } else { %>
    -
  <% } %>
</td>


      

        <td><%= c.subscriptions.length %></td>
        <td><%= active %></td>
      </tr>
    <% }) %>
  </table>
<% } %>


  <% if (page === "subscriptions") { %>
  <h2>Subscriptions</h2>

  <table id="adminTable">
    <tr>
      <th>Subscription ID</th>
      <th>Customer</th>
      <th>Product</th>
      <!-- <th>Variant</th> -->
      <th>Frequency</th>
      <th>Qty</th>
      <th>Delivery Days</th>
      <th>Status</th>
      <!-- <th>One-Time</th> -->
      <th>Total</th>
      <th>Delivery Fee</th>
      <th>	Subscription Start</th>
      <th>Next Shipping</th>
      <th>End Date</th>
      
      <th>Actions</th>
    </tr>

    <% subscriptions.forEach(s => { %>
      <tr>
        <td><%= s.id %></td>

        <td><%= s.customer.email %></td>

        <td><%= s.product %></td>

        <!-- <td><%= s.variantId || "-" %></td> -->

        <td><%= s.frequency %></td>

        <td><%= s.quantity %></td>

        <td><%= s.deliveryDays || "-" %></td>

        <td><strong><%= s.status %></strong></td>

        <!-- <td><%= s.isOneTimePurchase ? "Yes" : "No" %></td> -->

        <td>₹<%= s.totalAmount %></td>

        <td>₹<%= s.deliveryFee %></td>
<td><%= new Date(s.createdAt).toLocaleString("en-IN", {
      timeZone: "Asia/Kolkata",
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
  })%></td>

        <td>
          <%= s.nextShippingDate
            ? new Date(s.nextShippingDate).toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      })
            : "-" %>
        </td>

        <td>
          <%= s.subscriptionEndDate
            ? new Date(s.subscriptionEndDate).toLocaleString("en-IN", {
        timeZone: "Asia/Kolkata",
        day: "2-digit",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      })
            : "-" %>
        </td>

        
     <td class="action-cell">
  <% if (s.status === "active") { %>

    <form method="POST"
          action="/admin/subscription/<%= s.id %>/action"
          class="action-form">
      <input type="hidden" name="action" value="stop">
      <button type="submit" class="btn btn-warning">Stop</button>
    </form>

    <button type="button"
            class="btn btn-secondary"
            onclick="openOrdersModal('<%= s.id %>')">
      View Orders
    </button>

    <form method="POST"
          action="/admin/subscription/<%= s.id %>/action"
          class="action-form">
      <input type="hidden" name="action" value="cancel">
      <button type="submit" class="btn btn-danger">Cancel</button>
    </form>

  <% } else if (s.status === "stopped") { %>

    <form method="POST"
          action="/admin/subscription/<%= s.id %>/action"
          class="action-form">
      <input type="hidden" name="action" value="resume">
      <button type="submit" class="btn btn-success">Resume</button>
    </form>

    <button type="button"
            class="btn btn-secondary"
            onclick="openOrdersModal('<%= s.id %>')">
      View Orders
    </button>

    <form method="POST"
          action="/admin/subscription/<%= s.id %>/action"
          class="action-form">
      <input type="hidden" name="action" value="cancel">
      <button type="submit" class="btn btn-danger">Cancel</button>
    </form>

  <% } else { %>
    -
  <% } %>
</td>

      </tr>
    <% }) %>
  </table>
<% } %>



   <% if (page === "shopify-orders") { %>
  <h2>Shopify Orders</h2>

  <table id="adminTable">
    <tr>
      <th>Shopify Order ID</th>
      <th>Subscription ID</th>
      <th>Customer</th>
      <th>Product</th>
      
      <th>Frequency</th>
      
      <th>Shipping Date</th>
      <th>Status</th>
      <th>Created</th>
      <th>Action</th>
    </tr>

    <% shopifyOrders.forEach(o => { %>
      <tr>
        <!-- Shopify Order ID -->
        <td>
          <% if (o.shopifyOrderId) { %>
           PBW<%= o.order_number %>
          <% } else { %>
            -
          <% } %>
        </td>
         <!-- ✅ Subscription ID -->
        <td style="font-size:12px;">
          <%= o.subscription.id %>
        </td>
        <td><%= o.subscription.customer.email %></td>
        <td><%= o.subscription.product %></td>

       

        <!-- ✅ Frequency -->
        <td>
          <%= o.subscription.frequency %>
        </td>

        

        <td><%= o.shippingDate.toDateString() %></td>

        <td><strong><%= o.status %></strong></td>

        <td><%= o.createdAt.toDateString() %></td>

        <td>
          <form method="POST" action="/admin/shopify-order/<%= o.id %>/status">
            <select name="status" onchange="this.form.submit()">
              <option value="created" <%= o.status === "created" ? "selected" : "" %>>Created</option>
              <option value="processing" <%= o.status === "processing" ? "selected" : "" %>>Processing</option>
              <option value="shipped" <%= o.status === "shipped" ? "selected" : "" %>>Shipped</option>
              <option value="delivered" <%= o.status === "delivered" ? "selected" : "" %>>Delivered</option>
              <option value="cancelled" <%= o.status === "cancelled" ? "selected" : "" %>>Cancelled</option>
            </select>
          </form>
        </td>
      </tr>
    <% }) %>
  </table>
<% } %>


  </div>
</div>
<script>
function filterTable() {
  const input = document.getElementById("adminSearch");
  const filter = input.value.toLowerCase();
  const table = document.getElementById("adminTable");

  if (!table) return;

  const rows = table.getElementsByTagName("tr");

  for (let i = 1; i < rows.length; i++) {
    const rowText = rows[i].innerText.toLowerCase();
    rows[i].style.display = rowText.includes(filter) ? "" : "none";
  }
}
</script>
<div id="ordersModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:10000;
">

  <div style="
    background:#fff;
    max-width:900px;
    margin:60px auto;
    padding:20px;
    border-radius:8px;
    position:relative;
  ">
    <h3>Subscription Orders</h3>

    <button onclick="closeOrdersModal()"
      style="position:absolute; top:10px; right:10px;">
      ✕
    </button>

    <table style="margin-top:15px;">
      <thead>
        <tr>
          <th>Shopify Order ID</th>
          <th>Product</th>
          <th>Shipping Date</th>
          <th>Status</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody">
        <tr><td colspan="5">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</div>
<script>
async function openOrdersModal(subscriptionId) {
  document.getElementById("ordersModal").style.display = "block";
  const tbody = document.getElementById("ordersTableBody");

  tbody.innerHTML = `<tr><td colspan="5">Loading…</td></tr>`;

  const res = await fetch(`/admin/subscription/${subscriptionId}/orders`);
  const orders = await res.json();

  if (!orders.length) {
    tbody.innerHTML = `<tr><td colspan="5">No orders found</td></tr>`;
    return;
  }

  tbody.innerHTML = orders.map(o => `
    <tr>
      <td>
        ${o.shopifyOrderId
          ? `PBW${o.order_number}`
          : "-"}
      </td>
      <td>${o.product}</td>
      
      <td>${new Date(o.shippingDate).toDateString()}</td>
      <td><strong>${o.status}</strong></td>
      <td>${new Date(o.createdAt).toDateString()}</td>
    </tr>
  `).join("");
}

function closeOrdersModal() {
  document.getElementById("ordersModal").style.display = "none";
}
</script>
<script>
function togglePassword(btn) {
  const span = btn.previousElementSibling;
  const realPassword = span.getAttribute("data-password");

  if (span.innerText.includes("•")) {
    span.innerText = realPassword;
    btn.innerText = "Hide";
  } else {
    span.innerText = "••••••••";
    btn.innerText = "Show";
  }
}
</script>
<div id="addressModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:8px;
    width:400px;
    max-width:90%;
  ">
    <h3 style="margin-top:0;">Customer Address</h3>

    <div id="addressContent" style="line-height:1.6;"></div>

    <div style="text-align:right; margin-top:15px;">
      <button onclick="closeAddress()">Close</button>
    </div>
  </div>
</div>
<script>
function showAddress(address) {
  let html = "";

  if (address.line1) html += `<div><b>Line 1:</b> ${address.line1}</div>`;
  if (address.line2) html += `<div><b>Line 2:</b> ${address.line2}</div>`;
  if (address.city) html += `<div><b>City:</b> ${address.city}</div>`;
  if (address.state) html += `<div><b>State:</b> ${address.state}</div>`;
  if (address.pincode) html += `<div><b>Pincode:</b> ${address.pincode}</div>`;
  if (address.country) html += `<div><b>Country:</b> ${address.country}</div>`;

  document.getElementById("addressContent").innerHTML = html || "No address found";
  document.getElementById("addressModal").style.display = "flex";
}

function closeAddress() {
  document.getElementById("addressModal").style.display = "none";
}
</script>

</body>
</html>
